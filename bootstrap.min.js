!function(){function objectToQuery(a){var b=[],c=function(a){return a.replace(/^([\w\-]+)/,"[$1]")};return each(a,function(a,d){switch(d=encodeURIComponent(d),type(a)){case"object":each(objectToQuery(a).split("&"),function(){b.push(d+c(arguments[0]))});break;case"array":each(a,function(){b.push(d+"[]="+encodeURIComponent(arguments[0].toString()))});break;default:b.push(d+"="+encodeURIComponent(a))}}),b.join("&")}function queryToObject(a){var b={},c=function(a){return a.replace(regTripBracket,"")};return each(a.split("&"),function(a){var d,e,f;return a=a.split("="),2!==a.length?!0:(d=decodeURIComponent(a[0]),e=decodeURIComponent(a[1]),f=b,void each(d.match(regUrlKeys),function(a,b,d){var g=c(a),h=d[b+1];return g?void(h?"[]"===h?(void 0===f[g]&&(f[g]=[]),f[g].push(e)):"["===h.charAt(0)&&(void 0===f[g]&&(f[g]={}),f=f[g]):f[g]=e):!1}))}),b}function appendQuery(a,b){var c,d;return(d="object"===type(b)?objectToQuery(b):b)?(c=a.split("#"),c[0]=(c[0]+"&"+d).replace(/[&?]{1,2}/,"?"),c.join("#")):a}function resolve(a,b,c){var d=a.length,e=new Array(d),f=function(){0===d&&c(e)},g=function(a){return function(b){e[a]=b,d-=1,f()}};f(),each(a,function(a,c,d){b.call(d,a,g(c))})}function request(a,b,c){c=c||{};var d=c.error;return c.error=function(a,b,c){var e;d&&(e=d.apply(arguments)),e!==!1&&console.error("spa: ",b,c)},c.url=a,c.success=b,ajax(c)}function isOffline(){return navigator&&navigator.onLine===!1}function arrayDiff(a,b){var c=[],d=[];return each(a,function(a){-1===b.indexOf(a)&&c.push(a)}),each(b,function(b){-1===a.indexOf(b)&&d.push(b)}),{added:c,deleted:d}}function arrayFilter(a,b){var c=[];return each(a,function(a,d,e){!0===b(a,d,e)&&c.push(a)}),c}function dirname(a){return a=a.split(/[#\?]/).shift().replace(/\/$/,"").split("/"),a.pop(),a.join("/")}function extname(a){return a.split(/[#\?]/).shift().split(".").pop()}function getAbsoluteFile(a,b){var c=dirname(b);return a.split("/").forEach(function(a){".."===a?c=dirname(c):"."!==a&&(c+="/"+a)}),c}function isAbsoluteAsset(a){return/^https?:\/\//.test(a)}function replaceCssRelativeAsset(a,b){return b.replace(reCssAsset,function(b,c){return isAbsoluteAsset(c)?b:b.replace(c,getAbsoluteFile(c,a))})}function insertCSSCode(a){var b=document.createElement("style");b.type="text/css",b.media="screen",b.styleSheet?b.styleSheet.cssText=a:b.appendChild(document.createTextNode(a)),document.getElementsByTagName("head")[0].appendChild(b)}function insertJSCode(code){eval("eval")(code)}function slideDownUpdateTip(){var a=document.createElement("div");a.className="spa-stripe",a.style.cssText="position:fixed;top:0;left:0;right:0;height:0;background:rgba(0,0,0,.8);z-index:99999;overflow:hidden;",a.innerHTML='<a style="display:block;line-height:50px;color:red;text-align:center;font-size:18px;">有新版本可用，请点此更新</a>',document.body.appendChild(a),a.querySelector("a").addEventListener("click",function(){BS.version(0),location.reload()});var b=1e3,c=+new Date,d=.4,e=50,f=0,g=function(){var h=+new Date-c;h>b?a.style.height=e+"px":(f+=(e-f)*d,a.style.height=f+"px",setTimeout(g,100))};setTimeout(g,30)}var type,each,extend,trim,ajax,Store,BS,regTripBracket=/\[|\]/g,regUrlKeys=/([\w\-]+)|(\[[\w\-]*\])/g;type=function(a){return Object.prototype.toString.call(a).replace(/^\[object (.+)\]$/,"$1").toLowerCase()},each=function(a,b,c){switch(type(a)){case"array":for(var d=0,e=a.length;e>d&&!1!==b.call(c,a[d],d,a);++d);break;case"object":for(var f in a)if(a.hasOwnProperty(f)&&!1===b.call(c,a[f],f,a))break}},extend=function(){var a,b,c;return a=[].slice.call(arguments),"boolean"===type(a[0])&&(b=a.shift()),c=a.shift()||{},each(a,function(a){"object"===type(a)&&each(a,function(a,d){c[d]=b&&"object"===type(a)?extend(c[d],a,b):a})}),c},trim=function(a){return a.replace(/^\s+|\s+$/,"")},ajax=function ajaxInitialize(){function ajaxBeforeSend(a,b){var c=b.context;return b.beforeSend.call(c,a,b)===!1?!1:void 0}function ajaxComplete(a,b,c){var d=c.context;c.complete.call(d,b,a)}function ajaxSuccess(a,b,c){var d=c.context,e="success";c.success.call(d,a,e,b),ajaxComplete(e,b,c)}function ajaxError(a,b,c,d){var e=d.context;d.error.call(e,c,b,a),ajaxComplete(b,c,d)}function mimeToDataType(a){return a&&(a=a.split(";",2)[0]),a&&(a===htmlType?"html":a===jsonType?"json":scriptTypeRE.test(a)?"script":xmlTypeRE.test(a)&&"xml")||"text"}function serializeData(a){a.processData&&a.data&&"string"!=typeof a.data&&(a.data=objectToQuery(a.data).replace(/%20/g,"+")),!a.data||a.type&&"GET"!==a.type.toUpperCase()||(a.url=appendQuery(a.url,a.data),a.data=void 0)}function ajax(options){var settings=extend({},config,options||{}),isXHR2ReturnType,isXHR2SendType,dataType=settings.dataType;settings.url||(settings.url=window.location.toString()),settings.crossDomain||(settings.crossDomain=/^([\w-]+:)?\/\/([^\/]+)/.test(settings.url)&&RegExp.$2!==window.location.host),settings.data&&"string"!=typeof settings.data&&"object"!==type(settings.data)?isXHR2SendType=!0:serializeData(settings),settings.cache===!1&&(settings.url=appendQuery(settings.url,"_="+Date.now()));var mime=settings.accepts[dataType],headers={},setHeader=function(a,b){headers[a.toLowerCase()]=[a,b]},protocol=/^([\w-]+:)\/\//.test(settings.url)?RegExp.$1:window.location.protocol,xhr=settings.xhr(),nativeSetHeader=xhr.setRequestHeader,abortTimeout;XHR2Types.indexOf&&XHR2Types.indexOf(dataType)>=0&&(xhr.responseType=dataType,isXHR2ReturnType=!0),settings.crossDomain||setHeader("X-Requested-With","XMLHttpRequest"),setHeader("Accept",mime||"*/*"),mime=settings.mimeType,mime&&(mime.indexOf(",")>-1&&(mime=mime.split(",",2)[0]),xhr.overrideMimeType&&xhr.overrideMimeType(mime)),!isXHR2SendType&&(settings.contentType||settings.contentType!==!1&&settings.data&&"GET"!==settings.type.toUpperCase())&&setHeader("Content-Type",settings.contentType||"application/x-www-form-urlencoded");var name;if(settings.headers)for(name in settings.headers)setHeader(name,settings.headers[name]);if(xhr.setRequestHeader=setHeader,xhr.onreadystatechange=function(){if(4===xhr.readyState){xhr.onreadystatechange=empty,clearTimeout(abortTimeout);var result,error=!1;if(xhr.status>=200&&xhr.status<300||304===xhr.status||0===xhr.status&&"file:"===protocol){dataType=dataType||mimeToDataType(settings.mimeType||xhr.getResponseHeader("content-type")),result=isXHR2ReturnType?xhr.response:xhr.responseText;try{switch(dataType){case"script":eval("eval")(result);break;case"xml":result=xhr.responseXML;break;case"json":result=blankRE.test(result)?null:JSON.parse(result)}}catch(e){error=e}error?ajaxError(error,"parsererror",xhr,settings):ajaxSuccess(result,xhr,settings)}else ajaxError(xhr.statusText||null,xhr.status?"error":"abort",xhr,settings)}},ajaxBeforeSend(xhr,settings)===!1)return xhr.abort(),ajaxError(null,"abort",xhr,settings),xhr;var async="async"in settings?settings.async:!0;xhr.open(settings.type,settings.url,async,settings.username,settings.password);for(name in headers)nativeSetHeader.apply(xhr,headers[name]);return settings.timeout>0&&(abortTimeout=setTimeout(function(){xhr.onreadystatechange=empty,xhr.abort(),ajaxError(null,"timeout",xhr,settings)},settings.timeout)),xhr.send(settings.data?settings.data:null),xhr}var empty=function(){},scriptTypeRE=/^(?:text|application)\/javascript/i,xmlTypeRE=/^(?:text|application)\/xml/i,jsonType="application/json",htmlType="text/html",blankRE=/^\s*$/,XHR2Types=["arraybuffer","blob","document"],config={type:"GET",url:null,beforeSend:empty,success:empty,error:empty,complete:empty,xhr:function(){return new window.XMLHttpRequest},accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:jsonType,xml:"application/xml, text/xml",html:htmlType,text:"text/plain"},timeout:0,processData:!0,cache:!1};return ajax}(),Store={prefix:function(a){var b="spa-bs_";return 0===a.indexOf(b)?a:b+a},set:function(a,b){return localStorage.setItem(this.prefix(a),JSON.stringify(b)),b},get:function(a){var b;try{b=JSON.parse(localStorage.getItem(this.prefix(a)))}catch(c){b=void 0}return b},has:function(a){return this.prefix(a)in localStorage},del:function(a){localStorage.removeItem(this.prefix(a))},empty:function(){for(var a in localStorage)localStorage.hasOwnProperty(a)&&this.prefix(a)===a&&localStorage.removeItem(a)}};var reCssAsset=/(?:src=|url\(\s*)['"]?([^'"\)#?]+)(?:[#?](?:[^'"\)]*))?['"]?\s*\)?/g;BS={version:function(a){return void 0===a?this._version?this._version:Store.get("version"):void(this._version=Store.set("version",parseInt(a,10)))},meta:function(a){return void 0===a?this._meta?this._meta:Store.get("meta"):void(this._meta=Store.set("meta",a))},metaAssetCompare:function(a,b){var c={added:[],deleted:[]};return b&&each(["css","js"],function(d){var e=arrayDiff(a[d],b[d]);c.deleted=c.deleted.concat(e.deleted)}),c.added=a.css.concat(a.js),c.added=arrayFilter(c.added,function(a){return!Store.has(a)}),c},checkCacheIntegrity:function(){if(!this.version())return!1;if(this.needLoadVersion&&this.needLoadVersion!==this.version())return!1;var a=this.meta();if(!a)return!1;var b=!0;return each(["css","js"],function(c){each(a[c],function(a){return Store.has(a)?void 0:(b=!1,!1)})}),b},fetchMeta:function(a,b){var c=this;request(a,function(a){if(0===a.status){var d=a.data;d.version=parseInt(d.version,10);try{d.meta=JSON.parse(d.data)}catch(e){}delete d.data,b.call(c,d)}else window.alert(a.status+": "+a.message)},{dataType:"json",error:function(){window.alert("网络出问题了，加载 meta 信息失败，请刷新重试")}})},fetchAssets:function(a,b){var c=this;resolve(a,function(a,b){request(a,function(a){b(a)},{cache:!0,dataType:"text",error:function(){b(!1)}})},function(d){var e={};each(a,function(a,b){e[a]=d[b]}),b.call(c,e)})},removeAssets:function(a){each(a,function(a){Store.del(a)})},run:function(a){this.metaUrl=a,this.appName=a.replace(/^.*?\bapp=([\w-]+).*?$/,"$1"),Store.get("app")!==this.appName&&Store.empty(),Store.set("app",this.appName);var b=queryToObject(location.search.substr(1));b.version&&/^\d+$/.test(b.version)&&(this.needLoadVersion=b.version-0),isOffline()||(this.checkCacheIntegrity()?(this.needLoadVersion||this.on("rendered",function(){this.checkUpdate()}),this.render()):this.load(this.needLoadVersion))},checkUpdate:function(){var a=this,b=this.version(),c=+new Date,d=this.metaUrl.replace("?m=","?m=check");setTimeout(function(){var e=Store.get("lastCheck");if(e&&e.version&&e.time){if(e.version>b)return void slideDownUpdateTip(e.version);if(c-e.time<864e5)return}a.fetchMeta(appendQuery(d,{version:b}),function(a){Store.set("lastCheck",{time:c,version:a.version}),a.version>b&&slideDownUpdateTip(a.version)})},2e3)},load:function(a){this.fetchMeta(appendQuery(this.metaUrl,{version:a||0}),function(a){var b=this.metaAssetCompare(a.meta,this.meta());this.version(a.version),this.meta(a.meta),this.removeAssets(b.deleted),this.fetchAssets(b.added,function(a){var b=[];each(a,function(a,c){a?("css"===extname(c)&&(a=replaceCssRelativeAsset(c,a)),Store.set(c,a)):b.push(c)}),b.length?window.alert("以下资源加载失败，请刷新重试！\r\n"+b.join("\r\n")):(this.trigger("loaded",a),this.render())})})},render:function(){var a=this.meta(),b=document.querySelector("head"),c=document.querySelector("body");b.innerHTML=a.head,c.innerHTML=a.body,each(a.bodyAttrs,function(a,b){c.setAttribute(b,a)}),each(a.css,function(a){insertCSSCode(Store.get(a))}),each(a.js,function(a){insertJSCode(Store.get(a))}),this.trigger("rendered")},_events:{},trigger:function(a){var b=arguments;each(this._events[a]||[],function(a){a.apply(this,b)},this)},on:function(a,b){a in this._events||(this._events[a]=[]),this._events[a].push(b)}},BS.run(document.querySelector("[spa-bootstrap]").getAttribute("spa-bootstrap"))}();